name: Docker Build and Deploy
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  REGISTRY: roxsross12
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: arc-runner-set
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Nuevo: Verificar y configurar Docker
      - name: Check Docker daemon
        run: |
          # Verificar si Docker está instalado
          if ! command -v docker &> /dev/null; then
            echo "Docker no está instalado. Instalando..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
          fi
          
          # Iniciar el servicio de Docker si no está corriendo
          if ! systemctl is-active --quiet docker; then
            sudo systemctl start docker
          fi
          
          # Agregar usuario al grupo docker
          sudo usermod -aG docker $USER
          
          # Verificar el estado de Docker
          sudo systemctl status docker
          
          # Asegurarse que el socket tenga los permisos correctos
          sudo chmod 666 /var/run/docker.sock

